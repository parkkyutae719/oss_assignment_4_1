<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AJAX CRUD (XHR) - Product Code</title>
    <style>
        body { font-family: sans-serif; margin: 20px; }
        h1 { font-size: 1.5em; }
        .controls { padding: 10px; border: 1px solid #ccc; background-color: #f4f4f4; border-radius: 5px; }
        .controls div { margin-bottom: 5px; }
        .controls label { display: inline-block; width: 80px; text-align: right; margin-right: 5px; }
        .controls input { padding: 4px; width: 200px; }
        .buttons { margin-left: 90px; margin-top: 10px; }
        .buttons button { margin-left: 5px; padding: 4px 8px; cursor: pointer; }
        #results-list { margin-top: 20px; }
        #results-list ul { list-style-type: none; padding-left: 0; }
        #results-list li { padding: 8px; border: 1px solid #ddd; margin-bottom: 5px; }
    </style>
</head>
<body>

    <h1>목록!</h1>

    <div class="controls">
        <div>
            <label for="product-code">Code:</label>
            <input type="text" id="product-code" placeholder="예: E-007 (필수)">
        </div>
        <div>
            <label for="product-name">name:</label>
            <input type="text" id="product-name" placeholder="상품명">
        </div>
        <div>
            <label for="product-price">price:</label>
            <input type="number" id="product-price" placeholder="가격">
        </div>
        <div>
            <label for="product-category">category:</label>
            <input type="text" id="product-category" placeholder="카테고리">
        </div>

        <div class="buttons">
            <button id="btn-create">입력하기</button>
            <button id="btn-update">수정하기</button>
            <button id="btn-delete">삭제하기</button>
            <button id="btn-read">조회하기</button>
        </div>
    </div>

    <div id="results-list">
    </div>

    <script>
        const API_URL = 'http://localhost:3001/products';

        const codeInput = document.getElementById('product-code');
        const nameInput = document.getElementById('product-name');
        const priceInput = document.getElementById('product-price');
        const categoryInput = document.getElementById('product-category');
        
        const resultsList = document.getElementById('results-list');

        const btnRead = document.getElementById('btn-read');
        const btnCreate = document.getElementById('btn-create');
        const btnUpdate = document.getElementById('btn-update');
        const btnDelete = document.getElementById('btn-delete');

        window.onload = function()
        {
            btnRead.addEventListener('click', getProducts);
            btnCreate.addEventListener('click', postData);
            btnUpdate.addEventListener('click', updateProduct);
            btnDelete.addEventListener('click', deleteProduct);
        };

        function getProducts()
        {
            const xhr = new XMLHttpRequest();
            xhr.open("GET", API_URL);
            xhr.setRequestHeader("content-type", "application/json");
            
            xhr.onload = function()
            {
                if (xhr.status === 200)
                {
                    const res = JSON.parse(xhr.response);
                    resultsList.innerHTML = makeList(res);
                }
                else
                {
                    console.log(xhr.status, xhr.statusText);
                }
            };
            xhr.send();
        }

        function makeList(data)
        {
            let str = "<ul>";
            for (let key in data)
            {
                str += `<li>Code: ${data[key].id}, ${data[key].name} (${data[key].category}) - 가격: ${data[key].price}</li>`;
            }
            str += "</ul>";
            return str;
        }

        function postData()
        {
            const code = codeInput.value;
            const name = nameInput.value;
            const price = priceInput.value;
            const category = categoryInput.value;

            if (!code || !name || !price || !category)
            {
                alert("Code, name, price, category를 모두 입력하세요.");
                return;
            }

            const xhr = new XMLHttpRequest();
            xhr.open("POST", API_URL);
            xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");
            
            const data = { 
                id: code,
                name: name, 
                price: Number(price), 
                category: category 
            };
            
            xhr.send(JSON.stringify(data));
            
            xhr.onload = function()
            {
                if (xhr.status === 201)
                {
                    resetFields();
                    getProducts(); 
                }
                else if (xhr.status === 500) 
                {
                    alert("오류: Product Code가 중복되었습니다. 목록에 없는 새 Code를 입력하세요.");
                }
                else
                {
                    console.log(xhr.status, xhr.statusText);
                }
            };
        }

        function updateProduct()
        {
            const code = codeInput.value;
            const name = nameInput.value;
            const price = priceInput.value;
            const category = categoryInput.value;

            if (!code || !name || !price || !category)
            {
                alert("Code, name, price, category를 모두 입력해야 수정됩니다.");
                return;
            }

            const xhr = new XMLHttpRequest();
            xhr.open("PUT", `${API_URL}/${code}`);
            xhr.setRequestHeader("content-type", "application/json; charset=UTF-8");

            const data = { 
                id: code,
                name: name, 
                price: Number(price), 
                category: category
            };
            
            xhr.send(JSON.stringify(data));
            
            xhr.onload = function()
            {
                if (xhr.status === 200)
                {
                    resetFields();
                    getProducts(); 
                }
                else
                {
                    console.log(xhr.status, xhr.statusText);
                }
            };
        }

        function deleteProduct()
        {
            const code = codeInput.value;
            if (!code)
            {
                alert("삭제할 Code를 입력하세요.");
                return;
            }

            if (!confirm(`[Code: ${code}] 상품을 정말 삭제하시겠습니까?`))
            {
                return;
            }

            const xhr = new XMLHttpRequest();
            xhr.open("DELETE", `${API_URL}/${code}`);
            
            xhr.onload = function()
            {
                if (xhr.status === 200)
                {
                    resetFields();
                    getProducts(); 
                }
                else
                {
                    console.log(xhr.status, xhr.statusText);
                }
            };
            xhr.send();
        }

        function resetFields()
        {
            codeInput.value = "";
            nameInput.value = "";
            priceInput.value = "";
            categoryInput.value = "";
        }

    </script>
</body>
</html>